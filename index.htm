<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Excel Split Tool - Remove Formula & Keep Format</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
body { font-family: Arial; padding: 20px; background:#f5f5f5; }
.container {
    background:white; padding:20px; border-radius:10px;
    max-width:900px; margin:auto;
    box-shadow:0 0 10px rgba(0,0,0,0.2);
}
select,input,button { padding:8px; margin:10px 0; width:100%; }
button { background:#1976d2; color:white; border:none; cursor:pointer; }
button:hover { background:#125ea8; }
.progress-bar { width:100%; background:#ddd; height:20px; border-radius:10px; overflow:hidden; }
.progress { height:100%; width:0%; background:#4caf50; }
.status { margin-top:15px; font-weight:bold; }
</style>
</head>

<body>

<div class="container">
<h2>Excel Split Tools(Tins) </h2>

<input type="file" id="fileInput" accept=".xlsx,.xlsb">

<label>Select Sheet:</label>
<select id="sheetSelect"></select>

<label>Select Columns to Split (Ctrl + Click):</label>
<select id="columnSelect" multiple size="8"></select>

<label>Separator:</label>
<input type="text" id="separator" value="-" />

<button onclick="splitFile()">Split & Download ZIP</button>

<div class="progress-bar">
<div class="progress" id="progressBar"></div>
</div>

<div class="status" id="status"></div>
</div>

<script>

let workbook;

document.getElementById("fileInput").addEventListener("change", function(e) {

    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = function(event) {

        const data = new Uint8Array(event.target.result);

        workbook = XLSX.read(data, {
            type: 'array',
            cellStyles: true,
            cellNF: true,
            cellDates: true
        });

        const sheetSelect = document.getElementById("sheetSelect");
        sheetSelect.innerHTML = "";

        workbook.SheetNames.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.text = name;
            sheetSelect.appendChild(opt);
        });

        loadSheet();
    };

    reader.readAsArrayBuffer(file);
});

document.getElementById("sheetSelect").addEventListener("change", loadSheet);

function loadSheet(){

    const sheetName = document.getElementById("sheetSelect").value;
    const ws = workbook.Sheets[sheetName];

    const range = XLSX.utils.decode_range(ws['!ref']);
    const headerRow = range.s.r;

    const columnSelect = document.getElementById("columnSelect");
    columnSelect.innerHTML = "";

    for(let C = range.s.c; C <= range.e.c; C++){
        const addr = XLSX.utils.encode_cell({r:headerRow,c:C});
        const cell = ws[addr];
        const text = cell ? cell.v : ("Column " + C);

        const opt = document.createElement("option");
        opt.value = C;
        opt.text = text;
        columnSelect.appendChild(opt);
    }

    document.getElementById("status").innerText = "Sheet loaded.";
}

function sanitize(name){
    return String(name).trim()
        .replace(/[\\\/:*?"<>|]/g,"_")
        .replace(/\s+/g,"_");
}

async function splitFile(){

    const selected = Array.from(document.getElementById("columnSelect").selectedOptions);
    if(selected.length===0){
        alert("Select at least one column");
        return;
    }

    const cols = selected.map(o=>parseInt(o.value));
    const sep = document.getElementById("separator").value || "-";
    const sheetName = document.getElementById("sheetSelect").value;
    const ws = workbook.Sheets[sheetName];

    const range = XLSX.utils.decode_range(ws['!ref']);
    const headerRow = range.s.r;

    const groups = {};
    const progress = document.getElementById("progressBar");
    const status = document.getElementById("status");

    progress.style.width="0%";
    status.innerText="Grouping rows...";

    for(let R=headerRow+1; R<=range.e.r; R++){

        let keyParts=[];
        cols.forEach(c=>{
            const addr = XLSX.utils.encode_cell({r:R,c:c});
            const cell = ws[addr];
            keyParts.push(cell ? cell.v : "EMPTY");
        });

        const key = keyParts.join(sep);
        if(!groups[key]) groups[key]=[];
        groups[key].push(R);
    }

    const zip = new JSZip();
    let count=0;

    for(const key in groups){

        const newSheet = {};

        // Copy column width
        if(ws['!cols']){
            newSheet['!cols'] = JSON.parse(JSON.stringify(ws['!cols']));
        }

        // Copy merges
        if(ws['!merges']){
            newSheet['!merges'] = JSON.parse(JSON.stringify(ws['!merges']));
        }

        // Copy header
        for(let C=range.s.c; C<=range.e.c; C++){
            const addr = XLSX.utils.encode_cell({r:headerRow,c:C});
            if(ws[addr]){
                const newCell = {...ws[addr]};
                delete newCell.f; // remove formula
                newSheet[addr]=newCell;
            }
        }

        let newRow=headerRow+1;

        groups[key].forEach(oldRow=>{

            for(let C=range.s.c; C<=range.e.c; C++){

                const oldAddr = XLSX.utils.encode_cell({r:oldRow,c:C});
                const newAddr = XLSX.utils.encode_cell({r:newRow,c:C});
                const oldCell = ws[oldAddr];
                if(!oldCell) continue;

                const newCell={...oldCell};

                delete newCell.f; // ðŸ”¥ remove formula completely

                newSheet[newAddr]=newCell;
            }

            newRow++;
        });

        newSheet['!ref']=XLSX.utils.encode_range({
            s:{r:headerRow,c:range.s.c},
            e:{r:newRow-1,c:range.e.c}
        });

        const newWB = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWB,newSheet,"Data");

        const wbout = XLSX.write(newWB,{
            bookType:'xlsx',
            type:'array',
            cellStyles:true
        });

        zip.file(sanitize(key)+".xlsx",wbout);

        count++;
        progress.style.width=(Math.round((count/Object.keys(groups).length)*100))+"%";
        await new Promise(r=>setTimeout(r,1));
    }

    status.innerText="Creating ZIP...";
    const blob = await zip.generateAsync({type:"blob"});
    saveAs(blob,"Split_Files_No_Formula_Keep_Format.zip");

    status.innerText="Done. Created "+count+" files.";
}

</script>

</body>
</html>